TEXT TO XSEL1 NOSHOW TEXTMERGE 

	
	SELECT A.CODIGO_FILIAL,C.FILIAL,A.TICKET,A.DATA_VENDA,A.TERMINAL,A.VALOR_CANCELADO,
	D.CODIGO_CLIENTE,D.CPF_CGC,D.ENDERECO,D.BAIRRO,D.CIDADE,D.CEP,D.UF,
	A.DATA_DIGITACAO,DATA_HORA_CANCELAMENTO,0 AS DIF_CANCELAMENTO 
	FROM LOJA_VENDA A 
	JOIN LOJA_VENDA_PGTO B 
	ON A.CODIGO_FILIAL=B.CODIGO_FILIAL 
	AND A.LANCAMENTO_CAIXA=B.LANCAMENTO_CAIXA 
	AND A.TERMINAL=B.TERMINAL 
	JOIN LOJAS_VAREJO C 
	ON A.CODIGO_FILIAL=C.CODIGO_FILIAL 
	JOIN CLIENTES_VAREJO D 
	ON A.CODIGO_CLIENTE=D.CODIGO_CLIENTE
	WHERE 
	B.NUMERO_CUPOM_FISCAL IS NOT NULL
	AND A.VALOR_CANCELADO>0 
                and a.data_hora_cancelamento is not null 
	AND A.DATA_VENDA BETWEEN '20101101' and '20101128' 
	ORDER BY C.FILIAL , A.DATA_VENDA , D.CODIGO_CLIENTE 

ENDTEXT 


TEXT TO XSEL2 NOSHOW TEXTMERGE 

	SELECT A.TICKET,A.CODIGO_FILIAL,A.FILIAL,A.DATA_VENDA,A.PRODUTO,B.DESC_PRODUTO,
	A.QTDE_CANCELADA,
	CONVERT(NUMERIC(14,2),(A.VALOR_CANCELADO_PROD / CASE WHEN A.QTDE_CANCELADA=0 THEN 1 ELSE A.QTDE_CANCELADA END )) AS PRECO_UNIT,
	A.VALOR_CANCELADO_PROD ,A.VALOR_CANCELADO_TICKET,
	A.CODIGO_CLIENTE,A.CPF_CGC,A.ENDERECO,A.BAIRRO,A.CIDADE,A.CEP,A.UF,
	A.DATA_DIGITACAO,A.DATA_HORA_CANCELAMENTO ,0 AS DIF_CANCELAMENTO 

	FROM 
		(SELECT E.TICKET,E.CODIGO_FILIAL,C.FILIAL,E.DATA_VENDA,E.PRODUTO,
		SUM(E.QTDE_CANCELADA) AS QTDE_CANCELADA,
		SUM(E.QTDE_CANCELADA*E.PRECO_LIQUIDO) AS VALOR_CANCELADO_PROD ,
		A.VALOR_CANCELADO AS VALOR_CANCELADO_TICKET,
		D.CODIGO_CLIENTE,D.CPF_CGC,D.ENDERECO,D.BAIRRO,D.CIDADE,D.CEP,D.UF,
		A.DATA_DIGITACAO,DATA_HORA_CANCELAMENTO 
		FROM LOJA_VENDA A 
		JOIN LOJA_VENDA_PGTO B 
		ON A.CODIGO_FILIAL=B.CODIGO_FILIAL 
		AND A.LANCAMENTO_CAIXA=B.LANCAMENTO_CAIXA 
		AND A.TERMINAL=B.TERMINAL 
		JOIN LOJAS_VAREJO C 
		ON A.CODIGO_FILIAL=C.CODIGO_FILIAL 
		JOIN CLIENTES_VAREJO D 
		ON A.CODIGO_CLIENTE=D.CODIGO_CLIENTE 
		JOIN LOJA_VENDA_PRODUTO E 
		ON A.CODIGO_FILIAL=E.CODIGO_FILIAL 
		AND A.DATA_VENDA=E.DATA_VENDA 
		AND A.TICKET=E.TICKET 
		WHERE 
		B.NUMERO_CUPOM_FISCAL IS NOT NULL
		AND A.VALOR_CANCELADO>0 
		AND A.DATA_VENDA BETWEEN  '20101101' and '20101128' 
                                and a.data_hora_cancelamento is not null 
		GROUP BY E.TICKET,E.CODIGO_FILIAL,C.FILIAL,E.DATA_VENDA,E.PRODUTO,A.VALOR_CANCELADO,
	A.TERMINAL,A.DATA_DIGITACAO,D.CODIGO_CLIENTE,D.CPF_CGC,D.ENDERECO,D.BAIRRO,D.CIDADE,D.CEP,D.UF,
	DATA_HORA_CANCELAMENTO) A
	JOIN PRODUTOS B 
	ON A.PRODUTO=B.PRODUTO

ENDTEXT 



F_SELECT(XSEL1,"CURVENDASCANC")


SELECT CURVENDASCANC 
GO TOP

SCAN 

	TEXT TO XSEL3 NOSHOW TEXTMERGE 

		SELECT A.* FROM LOJA_VENDA A 
		JOIN LOJA_VENDA_PGTO B 
		ON A.CODIGO_FILIAL=B.CODIGO_FILIAL 
		AND A.LANCAMENTO_CAIXA=B.LANCAMENTO_CAIXA 
		AND A.TERMINAL=B.TERMINAL 
		WHERE 
		B.NUMERO_CUPOM_FISCAL IS NOT NULL
		AND A.CODIGO_FILIAL='<<CURVENDASCANC.CODIGO_FILIAL>>' 
		AND A.DATA_VENDA ='<<CURVENDASCANC.DATA_VENDA>>'   
		AND A.DATA_DIGITACAO > '<<CURVENDASCANC.DATA_DIGITACAO>>' 
		AND A.DATA_DIGITACAO < '<<CURVENDASCANC.DATA_HORA_CANCELAMENTO>>'

	ENDTEXT 


	F_SELECT(XSEL3,"CUR_VENDAS_ENTRE_CANC")

	SELECT CUR_VENDAS_ENTRE_CANC 
	IF RECCOUNT()>0
		SELECT CURVENDASCANC 
		REPLACE DIF_CANCELAMENTO WITH 1
	ENDIF

ENDSCAN 




F_SELECT(XSEL2,"CURVENDASCANC_ANALITICO")


SELECT CURVENDASCANC_ANALITICO 
GO TOP

SCAN 

	TEXT TO XSEL4 NOSHOW TEXTMERGE 


		SELECT A.* FROM LOJA_VENDA A 
		JOIN LOJA_VENDA_PGTO B 
		ON A.CODIGO_FILIAL=B.CODIGO_FILIAL 
		AND A.LANCAMENTO_CAIXA=B.LANCAMENTO_CAIXA 
		AND A.TERMINAL=B.TERMINAL 
		WHERE 
		B.NUMERO_CUPOM_FISCAL IS NOT NULL
		AND A.CODIGO_FILIAL='<<CURVENDASCANC_ANALITICO.CODIGO_FILIAL>>' 
		AND A.DATA_VENDA ='<<CURVENDASCANC_ANALITICO.DATA_VENDA>>'   
		AND A.DATA_DIGITACAO > '<<CURVENDASCANC_ANALITICO.DATA_DIGITACAO>>' 
		AND A.DATA_DIGITACAO < '<<CURVENDASCANC_ANALITICO.DATA_HORA_CANCELAMENTO>>'

	ENDTEXT 


	F_SELECT(XSEL4,"CUR_VENDAS_ENTRE_CANC")

	SELECT CUR_VENDAS_ENTRE_CANC 
	IF RECCOUNT()>0
		SELECT CURVENDASCANC_ANALITICO 
		REPLACE DIF_CANCELAMENTO WITH 1
	ENDIF

ENDSCAN 


SELECT * FROM CURVENDASCANC WHERE DIF_CANCELAMENTO = 1 ORDER BY FILIAL,DATA_VENDA,TICKET INTO CURSOR CUR_CANCELAMENTOS_DIF 
COPY TO C:\TEMP\CANCELAMENTOS_DIF.XLS XLS

SELECT * FROM CURVENDASCANC_ANALITICO WHERE DIF_CANCELAMENTO = 1 ORDER BY FILIAL,DATA_VENDA,TICKET,PRODUTO INTO CURSOR CUR_CANCELAMENTOS_ANALITICO_DIF 
COPY TO C:\TEMP\CANCELAMENTOS_ANALITICO_DIF.XLS XLS

MESSAGEBOX("Os Arquivos c:\temp\cancelamentos_dif.xls e c:\temp\cancelamentos_analitico_dif.xls foram gerados com Sucesso!",48,"Atenção!!") 