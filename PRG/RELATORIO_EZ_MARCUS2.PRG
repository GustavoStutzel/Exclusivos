

****EXPORTA SMS ABRAND****************************


Local xDataIni,xDataFim

xDataIni =  '20120901'
xDataFim = '20120930'

TEXT TO XSEL NOSHOW TEXTMERGE


   SELECT * FROM
   
   (SELECT CODIGO_FILIAL,FILIAL,TERMINAL,SUM(REDUCAO_LIQ) AS TOTAL_REDUCAO_LIQ,
   CONVERT(VARCHAR(100),'') AS OBS  FROM  
  
   (SELECT A.CODIGO_FILIAL,FILIAL,TERMINAL,DATA_FISCAL,  
   (TOTAL_BRUTO-TOTAL_CANCELADO-TOTAL_DESCONTO-ISNULL(B.TOTAL_CANCELAMENTO,0)) AS REDUCAO_LIQ
 
   FROM LOJA_CONTROLE_FISCAL A  
  
   LEFT JOIN (SELECT CODIGO_FILIAL,EMISSAO,SUM(VALOR_TOTAL) AS TOTAL_CANCELAMENTO   
   FROM LOJA_NOTA_FISCAL WHERE NATUREZA_OPERACAO_CODIGO IN ('1202.2','1202.3','1202.1')  
   AND NOTA_CANCELADA = 0 AND SERIE_NF = '5' GROUP BY CODIGO_FILIAL,EMISSAO) B  
  
   ON A.CODIGO_FILIAL = B.CODIGO_FILIAL  
   AND A.DATA_FISCAL = B.EMISSAO  
  
   WHERE A.DATA_FISCAL BETWEEN '<<xDataIni>>'  and '<<xDataFim>>' 
   ) A  
   GROUP BY CODIGO_FILIAL,FILIAL,TERMINAL  ) A
   
 

ENDTEXT 

F_SELECT(XSEL,"CUR_EXPORTA")

SELE CUR_EXPORTA
GO TOP
SCAN

         TEXT TO xInsereObs TEXTMERGE NOSHOW

   SELECT A.CODIGO_FILIAL,CONVERT(VARCHAR(11),A.DATA_FISCAL-1) AS DATA_FISCAL
   FROM LOJA_CONTROLE_FISCAL A   
   LEFT JOIN LOJA_CONTROLE_FISCAL B  
   ON A.ID_EQUIPAMENTO = B.ID_EQUIPAMENTO
   AND A.GT_INICIAL = B.GT_FINAL  
   WHERE A.DATA_FISCAL BETWEEN '<<xDataIni>>'  and '<<xDataFim>>'
   AND B.DATA_FISCAL IS NULL AND A.CODIGO_FILIAL = '<<CUR_EXPORTA.CODIGO_FILIAL>>'
        AND A.GT_INICIAL > 5

      ENDTEXT
      F_SELECT(xInsereObs,"CUR_OBS")

        xObs = ''  

        SELE CUR_OBS
        GO TOP 
        SCAN
            xObs = xObs+CUR_OBS.data_fiscal+", "
       ENDSCAN
      
      SELE CUR_EXPORTA
      REPLACE CUR_EXPORTA.OBS with iif(f_vazio(xObs),'','DIAS SEM RED.Z: '+xObs)
              
     SELE CUR_EXPORTA
ENDSCAN

SELE CUR_EXPORTA

COPY TO "C:\Relatorio_EZ_01092012_30092012.XLS" XLS 
